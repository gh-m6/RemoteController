<!DOCTYPE html>
<html>
<head>
    <title>Device Remote Control</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 90%; max-width: 400px; }
        h1 { font-size: 1.8em; margin-top: 0; color: #1c1e21; }
        h2 { font-size: 1.2em; color: #606770; border-bottom: 1px solid #ddd; padding-bottom: 8px; margin-top: 20px; }
        p { display: flex; justify-content: space-between; margin: 12px 0; font-size: 1.1em; }
        .label { color: #606770; }
        .value { font-weight: 600; color: #1c1e21; padding: 3px 8px; border-radius: 6px; transition: background-color 0.5s; }
        .btn-group { display: flex; justify-content: space-between; margin-top: 15px; }
        .btn { flex-grow: 1; padding: 18px 10px; font-size: 1.2em; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        .btn:first-child { margin-right: 10px; }
        .btn-on { background-color: #42b72a; color: white; }
        .btn-on:hover { background-color: #36a420; }
        .btn-off { background-color: #fa3e3e; color: white; }
        .btn-off:hover { background-color: #e03030; }
        .status-on { color: #42b72a; }
        .status-off { color: #fa3e3e; }
        .status-high { color: #1877f2; }
        .status-low { color: #606770; }
        #mqtt_status { font-weight: bold; }

        .device-selector { display: flex; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 20px; }
        #deviceSelect { flex-grow: 1; font-size: 1.1em; padding: 10px; border-radius: 6px; border: 1px solid #ccc; }
        .device-selector button { font-size: 1.5em; width: 40px; height: 40px; margin-left: 8px; border: none; background-color: #e4e6eb; border-radius: 50%; cursor: pointer; }
        .device-selector button:hover { background-color: #d8dbdf; }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 20px 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-content h2 { margin-top: 0; border-bottom: none; }
        #deviceForm label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: 600;
            color: #606770;
            font-size: 0.9em;
        }
        #deviceForm input[type="text"],
        #deviceForm input[type="password"],
        #deviceForm input[type="number"] {
            width: 100%;
            padding: 10px;
            font-size: 1em;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
        }
        #deviceForm small { font-size: 0.8em; color: #606770; display: block; margin-top: 3px; }
        .modal-buttons { display: flex; justify-content: flex-end; margin-top: 25px; }
        .modal-buttons button { padding: 10px 20px; border-radius: 8px; border: none; font-size: 1em; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        .modal-buttons #cancelDeviceBtn { background-color: #e4e6eb; color: #1c1e21; margin-right: 10px; }
        .modal-buttons #cancelDeviceBtn:hover { background-color: #d8dbdf; }
        .modal-buttons #saveDeviceBtn { background-color: #1877f2; color: white; }
        .modal-buttons #saveDeviceBtn:hover { background-color: #166fe5; }
    </style>
    <!-- Paho MQTT Client Library from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Remote Control</h1>

        <div class="device-selector">
            <select id="deviceSelect"></select>
            <button id="addDeviceBtn" title="Add new device">+</button>
            <button id="editDeviceBtn" title="Edit selected device">✎</button>
            <button id="deleteDeviceBtn" title="Delete selected device">🗑</button>
        </div>

        <p><span class="label">MQTT Status:</span> <span id="mqtt_status" class="value">--</span></p>
        <p><span class="label">Last Update:</span> <span id="last_update" class="value">--</span></p>
        
        <h2>Device Status</h2>
        <p><span class="label">Device Time:</span> <span id="device_time" class="value">--</span></p>
        <p><span class="label">Uptime:</span> <span id="uptime" class="value">--</span></p>
        <p><span class="label">Software Version:</span> <span id="soft_ver" class="value">--</span></p>
        <p><span class="label">App Status:</span> <span id="app_status" class="value">--</span></p>
        <p><span class="label">Error Code:</span> <span id="error_code" class="value">--</span></p>

        <h2>Sensors</h2>
        <p><span class="label">IN0:</span> <span id="li0_state" class="value">--</span></p>
        <p><span class="label">IN1:</span> <span id="li1_state" class="value">--</span></p>
        <p><span class="label">Temperature:</span> <span id="temp_adc1_c_val" class="value">-- &deg;C</span></p>
        <p><span class="label">Soil Moisture:</span> <span id="adc0_val" class="value">-- mV</span></p>
        
        <h2>GPIO Output (GP2)</h2>
        <div style="margin-bottom: 15px;">
            <p><span class="label">OUT0:</span> <span id="out0_state" class="value">--</span></p>
            <div class="btn-group">
                <button type="button" id="out0_on_btn" class="btn btn-on">Turn ON</button>
                <button type="button" id="out0_off_btn" class="btn btn-off">Turn OFF</button>
            </div>
        </div>
        <div>
            <p><span class="label">OUT1:</span> <span id="out1_state" class="value">--</span></p>
            <div class="btn-group">
                <button type="button" id="out1_on_btn" class="btn btn-on">Turn ON</button>
                <button type="button" id="out1_off_btn" class="btn btn-off">Turn OFF</button>
            </div>
        </div>
    </div>

    <div id="deviceModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Add Device</h2>
            <form id="deviceForm">
                <input type="hidden" id="editDeviceId">
                
                <label for="deviceName">Nickname</label>
                <input type="text" id="deviceName" required>

                <label for="deviceId">Device ID</label>
                <input type="text" id="deviceId" required>

                <label for="devicePassword">MQTT Password</label>
                <input type="password" id="devicePassword">
                <small>Leave blank to keep current password when editing.</small>

                <label for="deviceBroker">MQTT Broker Host</label>
                <input type="text" id="deviceBroker" required>

                <label for="deviceWsPort">MQTT WebSocket Port</label>
                <input type="number" id="deviceWsPort" required>

                <label for="deviceUsername">MQTT Username</label>
                <input type="text" id="deviceUsername">

                <div class="modal-buttons">
                    <button type="button" id="cancelDeviceBtn">Cancel</button>
                    <button type="submit" id="saveDeviceBtn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let currentDeviceConfig = null;

            let mqttClient = null;
            let stalenessTimer = null;
            // デフォルトの更新間隔60秒の1.5倍強に設定
            const STALE_DATA_TIMEOUT_MS = 95000; 

            function updateUI(id, value, className = null) {
                const element = document.getElementById(id);
                if (element) {
                    const newClassName = className ? 'value ' + className : 'value';
                    // 比較と表示のために、受け取った値を文字列に変換する
                    // これにより、 '0' (文字列) と 0 (数値) が異なると判断される問題を回避する
                    const stringValue = (value === null || typeof value === 'undefined') ? element.innerHTML : String(value);
                    // 値またはクラス名が変更された場合にのみUIを更新し、ハイライトする
                    if (element.innerHTML !== stringValue || element.className !== newClassName) {
                        element.innerHTML = stringValue;
                        element.className = newClassName;
                        // ローカルWeb UIと同様のハイライト効果を適用
                        element.style.backgroundColor = '#cce5ff';
                        setTimeout(() => { element.style.backgroundColor = ''; }, 2000);
                    }
                }
            }

            function resetDisplay() {
                const fieldsToReset = {
                    'uptime': '--',
                    'soft_ver': '--',
                    'device_time': '--',
                    'app_status': '--',
                    'error_code': '--',
                    'li0_state': { value: '--', className: '' },
                    'li1_state': { value: '--', className: '' },
                    'temp_adc1_c_val': { value: '-- &deg;C' },
                    'adc0_val': { value: '-- mV' },
                    'out0_state': { value: '--', className: '' },
                    'out1_state': { value: '--', className: '' },
                    'last_update': '--',
                    'mqtt_status': '--'
                };

                for (const id in fieldsToReset) {
                    const field = fieldsToReset[id];
                    updateUI(id, (field.value !== undefined ? field.value : field), field.className || '');
                }
                if (stalenessTimer) {
                    clearTimeout(stalenessTimer);
                }
            }

            function onMessageArrived(message) {
                try {
                    // --- 1. 最終更新時刻と鮮度を更新 ---
                    const now = new Date();
                    const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
                    updateUI('last_update', `Received at ${timeString}`);
                    document.getElementById('last_update').className = 'value'; // 警告色をリセット

                    // 古い警告タイマーを解除し、新しいタイマーを設定
                    if (stalenessTimer) {
                        clearTimeout(stalenessTimer);
                    }
                    stalenessTimer = setTimeout(() => {
                        // このタイマーが作動するということは、一定時間データが来ていないということ
                        updateUI('last_update', 'Data is stale. Check device.', 'status-off');
                    }, STALE_DATA_TIMEOUT_MS);

                    // --- 2. 受信したデータを画面に表示 ---
                    const data = JSON.parse(message.payloadString);
                    const fields = {
                        'uptime': data.uptime,
                        'soft_ver': data.soft_ver,
                        'device_time': data.device_time,
                        'app_status': data.app_status,
                        'error_code': data.error_code,
                        'li0_state': { value: data.li0_state, className: data.li0_class },
                        'li1_state': { value: data.li1_state, className: data.li1_class },
                        'temp_adc1_c_val': { value: `${data.temp_adc1_c_val} &deg;C` },
                        'adc0_val': { value: `${data.adc0_val} mV` },
                        'out0_state': { value: data.out0_state, className: data.out0_class },
                        'out1_state': { value: data.out1_state, className: data.out1_class }
                    };
                    for (const id in fields) {
                        const field = fields[id];
                        if (typeof field === 'object' && field !== null) {
                            updateUI(id, field.value, field.className);
                        } else {
                            updateUI(id, field);
                        }
                    }
                } catch (e) {
                    console.error("Error parsing MQTT message:", e);
                }
            }

            function publishMqttCommand(command) {
                if (currentDeviceConfig && mqttClient && mqttClient.isConnected()) {
                    const message = new Paho.Message(JSON.stringify(command));
                    message.destinationName = `devices/${currentDeviceConfig.deviceId}/control`;
                    mqttClient.send(message);
                } else {
                    alert("MQTT not connected. Cannot send command.");
                }
            }

            // --- Event Listeners ---
            document.getElementById('out0_on_btn').addEventListener('click', () => publishMqttCommand({lo: {bit: 0, value: 1}}));
            document.getElementById('out0_off_btn').addEventListener('click', () => publishMqttCommand({lo: {bit: 0, value: 0}}));
            document.getElementById('out1_on_btn').addEventListener('click', () => publishMqttCommand({lo: {bit: 1, value: 1}}));
            document.getElementById('out1_off_btn').addEventListener('click', () => publishMqttCommand({lo: {bit: 1, value: 0}}));
            
            document.getElementById('addDeviceBtn').addEventListener('click', () => showDeviceModal());
            document.getElementById('editDeviceBtn').addEventListener('click', () => {
                const selectedId = document.getElementById('deviceSelect').value;
                if (!selectedId) {
                    alert("No device selected to edit.");
                    return;
                }
                const devices = loadDevices();
                const selectedDevice = devices.find(d => d.deviceId === selectedId);
                if (selectedDevice) {
                    showDeviceModal(selectedDevice);
                }
            });
            document.getElementById('deleteDeviceBtn').addEventListener('click', handleDeleteDevice);
            document.getElementById('deviceSelect').addEventListener('change', handleDeviceChange);
            document.getElementById('cancelDeviceBtn').addEventListener('click', hideDeviceModal);
            document.getElementById('deviceForm').addEventListener('submit', handleSaveDevice);
            
            function connectToDevice(deviceConfig) {
                if (!deviceConfig) return;

                currentDeviceConfig = deviceConfig;
                localStorage.setItem('deviceRemoteLastSelected', deviceConfig.deviceId);

                if (mqttClient && mqttClient.isConnected()) {
                    mqttClient.disconnect();
                }

                const clientId = "remote-control-" + Math.random().toString(36).substring(2, 15);
                mqttClient = new Paho.Client(deviceConfig.broker, Number(deviceConfig.ws_port), clientId);

                mqttClient.onConnectionLost = (response) => {
                    if (response.errorCode !== 0) {
                        updateUI('mqtt_status', `Connection Lost: ${response.errorMessage}`, 'status-off');
                        // ブローカーとの接続が切れたら、警告タイマーも停止
                        if (stalenessTimer) {
                            clearTimeout(stalenessTimer);
                        }
                        updateUI('last_update', 'Broker connection lost.', 'status-off');
                    }
                };
                mqttClient.onMessageArrived = onMessageArrived;

                const connectOptions = {
                    onSuccess: () => {
                        updateUI('mqtt_status', 'Connected', 'status-on');
                        mqttClient.subscribe(`devices/${deviceConfig.deviceId}/status`);
                    },
                    onFailure: (response) => {
                        updateUI('mqtt_status', `Failed: ${response.errorMessage}`, 'status-off');
                    },
                    userName: deviceConfig.username,
                    password: deviceConfig.password,
                    useSSL: true,
                    reconnect: true
                };
                updateUI('mqtt_status', 'Connecting...');
                mqttClient.connect(connectOptions);
            }

            // --- Device Management ---
            function loadDevices() {
                const saved = localStorage.getItem('deviceRemoteDevices');
                return saved ? JSON.parse(saved) : [];
            }

            function saveDevices(devices) {
                localStorage.setItem('deviceRemoteDevices', JSON.stringify(devices));
            }

            function populateDeviceSelector(devices, selectedDeviceId) {
                const select = document.getElementById('deviceSelect');
                select.innerHTML = '';
                devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.textContent = device.name;
                    if (device.deviceId === selectedDeviceId) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            }

            function showDeviceModal(device = null) {
                const form = document.getElementById('deviceForm');
                form.reset();

                const modalTitle = document.getElementById('modalTitle');
                const editDeviceIdInput = document.getElementById('editDeviceId');
                const deviceIdInput = document.getElementById('deviceId');

                if (device) { // Editing
                    modalTitle.textContent = 'Edit Device';
                    editDeviceIdInput.value = device.deviceId;
                    
                    document.getElementById('deviceName').value = device.name;
                    deviceIdInput.value = device.deviceId;
                    deviceIdInput.readOnly = true;
                    document.getElementById('devicePassword').placeholder = 'Leave blank to keep current';
                    document.getElementById('devicePassword').value = '';
                    document.getElementById('deviceBroker').value = device.broker;
                    document.getElementById('deviceWsPort').value = device.ws_port;
                    document.getElementById('deviceUsername').value = device.username;
                } else { // Adding
                    modalTitle.textContent = 'Add New Device';
                    editDeviceIdInput.value = '';
                    deviceIdInput.readOnly = false;
                    document.getElementById('devicePassword').placeholder = '';
                }

                document.getElementById('deviceModal').style.display = 'flex';
            }

            function hideDeviceModal() {
                document.getElementById('deviceModal').style.display = 'none';
            }

            function handleSaveDevice(event) {
                event.preventDefault();

                const editId = document.getElementById('editDeviceId').value;
                const isEditing = !!editId;

                const config = {
                    name: document.getElementById('deviceName').value.trim(),
                    deviceId: document.getElementById('deviceId').value.trim(),
                    password: document.getElementById('devicePassword').value,
                    broker: document.getElementById('deviceBroker').value.trim(),
                    ws_port: Number(document.getElementById('deviceWsPort').value),
                    username: document.getElementById('deviceUsername').value.trim()
                };

                if (!config.name || !config.deviceId || !config.broker || !config.ws_port) {
                    alert('Please fill in all required fields.');
                    return;
                }

                let devices = loadDevices();

                if (isEditing) {
                    const deviceIndex = devices.findIndex(d => d.deviceId === editId);
                    if (deviceIndex > -1) {
                        if (!config.password) config.password = devices[deviceIndex].password;
                        devices[deviceIndex] = config;
                    }
                } else {
                    if (devices.some(d => d.deviceId === config.deviceId)) {
                        alert('A device with this ID already exists.');
                        return;
                    }
                    devices.push(config);
                }
                saveDevices(devices);
                populateDeviceSelector(devices, config.deviceId);
                connectToDevice(config);
                hideDeviceModal();
            }

            function handleDeleteDevice() {
                const selectedId = document.getElementById('deviceSelect').value;
                if (!selectedId) {
                    alert("No device selected to delete.");
                    return;
                }
                if (!confirm(`Are you sure you want to delete the device "${document.getElementById('deviceSelect').options[document.getElementById('deviceSelect').selectedIndex].text}"?`)) {
                    return;
                }

                let devices = loadDevices();
                devices = devices.filter(d => d.deviceId !== selectedId);
                saveDevices(devices);
                
                // Reload the page to connect to the first available device or prompt for a new one
                location.reload();
            }

            function handleDeviceChange() {
                resetDisplay(); // デバイス切り替え時に表示をリセット
                const selectedId = document.getElementById('deviceSelect').value;
                const devices = loadDevices();
                const selectedDevice = devices.find(d => d.deviceId === selectedId);
                connectToDevice(selectedDevice);
            }

            // --- Initial Execution ---
            let devices = loadDevices();
            if (devices.length === 0) {
                alert("No devices configured. Let's add your first one.");
                showDeviceModal();
            } else {
                const lastSelectedId = localStorage.getItem('deviceRemoteLastSelected');
                populateDeviceSelector(devices, lastSelectedId);
                handleDeviceChange(); // Connect to the selected device
            }
        });
    </script>
</body>
</html>
