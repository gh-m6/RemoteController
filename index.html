<!DOCTYPE html>
<html>
<head>
    <title>Device Remote Control</title>
    <meta charset="UTF-8">
    <link rel="manifest" href="./manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 90%; max-width: 400px; }
        h1 { font-size: 1.8em; margin-top: 0; color: #1c1e21; }
        h2 { font-size: 1.2em; color: #606770; border-bottom: 1px solid #ddd; padding-bottom: 8px; margin-top: 20px; }
        p { display: flex; justify-content: space-between; margin: 12px 0; font-size: 1.1em; }
        .label { color: #606770; }
        .value { font-weight: 600; color: #1c1e21; padding: 3px 8px; border-radius: 6px; transition: background-color 0.5s; }
        .btn-group { display: flex; justify-content: space-between; margin-top: 15px; }
        .btn-group-single { display: flex; justify-content: center; margin-top: 15px; }
        .btn-group-vertical { display: flex; flex-direction: column; }
        .btn-group-vertical .btn { margin-bottom: 10px; }
        .btn-group-vertical .btn:last-child { margin-bottom: 0; }
        .btn { flex-grow: 1; padding: 18px 10px; font-size: 1.2em; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        .btn:first-child { margin-right: 10px; }
        .btn-on { background-color: #42b72a; color: white; }
        .btn-on:hover { background-color: #36a420; }
        .btn-off { background-color: #fa3e3e; color: white; }
        .btn-off:hover { background-color: #e03030; }
        .status-on { color: #42b72a; }
        .btn-action { background-color: #1877f2; color: white; }
        .btn-action:hover { background-color: #166fe5; }
        .btn:disabled { background-color: #e4e6eb; color: #bcc0c4; cursor: not-allowed; }
        /* ãƒ¢ãƒ€ãƒ³ãªãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
        .btn-push-off { background-color: #fff; color: #1877f2; border: 2px solid #1877f2; }
        .btn-push-off:hover:not(:disabled) { background-color: #f0f2f5; }
        .btn-push-on { background-color: #1877f2; color: white; border: 2px solid #1877f2; }
        .btn-push-on:hover:not(:disabled) { background-color: #166fe5; }
        /* ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ãƒœã‚¿ãƒ³ã®ã‚µã‚¤ã‚ºèª¿æ•´ */
        .btn-push { font-size: 0.9em; padding: 0 10px; margin-left: 8px; white-space: nowrap; }
        /* ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ãŒåˆ©ç”¨ã§ããªã„å ´åˆã®ãƒ†ã‚­ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
        .push-status-text {
            font-size: 0.9em;
            color: #606770; /* ã‚„ã‚„è–„ã„æ–‡å­—è‰² */
            margin-left: 8px;
        }

        .btn:disabled:hover { background-color: #e4e6eb; }

        .status-off { color: #fa3e3e; }
        .status-high { color: #1877f2; }
        .status-low { color: #606770; }
        #mqtt_status { font-weight: bold; }

        .device-selector { display: flex; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 20px; }
        #deviceSelect { flex-grow: 1; font-size: 1.1em; padding: 10px; border-radius: 6px; border: 1px solid #ccc; }
        .device-selector button { font-size: 1.5em; width: 40px; height: 40px; margin-left: 8px; border: none; background-color: #e4e6eb; border-radius: 50%; cursor: pointer; }
        .device-selector button:hover { background-color: #d8dbdf; }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 20px 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-content h2 { margin-top: 0; border-bottom: none; }
        #deviceForm label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: 600;
            color: #606770;
            font-size: 0.9em;
        }
        #deviceForm input[type="text"],
        #deviceForm input[type="password"],
        #deviceForm input[type="number"] {
            width: 100%;
            padding: 10px;
            font-size: 1em;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
        }
        #deviceForm small { font-size: 0.8em; color: #606770; display: block; margin-top: 3px; }
        .modal-buttons { display: flex; justify-content: flex-end; margin-top: 25px; }
        .modal-buttons button { padding: 10px 20px; border-radius: 8px; border: none; font-size: 1em; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        .modal-buttons #cancelDeviceBtn { background-color: #e4e6eb; color: #1c1e21; margin-right: 10px; }
        .modal-buttons #cancelDeviceBtn:hover { background-color: #d8dbdf; }
        .modal-buttons #saveDeviceBtn { background-color: #1877f2; color: white; }
        .modal-buttons #saveDeviceBtn:hover { background-color: #166fe5; }
    </style>
    <!-- Paho MQTT Client Library from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Remote Control</h1>

        <div class="device-selector">
            <select id="deviceSelect"></select>
            <button id="addDeviceBtn" title="Add new device">+</button>
            <button id="editDeviceBtn" title="Edit selected device">âœ</button>
            <button id="deleteDeviceBtn" title="Delete selected device">ğŸ—‘</button>
            <button type="button" id="pushSubscribeBtn" class="btn btn-push" style="display: none;"></button> <!-- é‡è¤‡ã‚’å‰Šé™¤ã—ã€åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤ºã« -->
            <span id="push-status-message" class="push-status-text" style="display: none;"></span>
        </div>


        <p><span class="label">MQTT Status:</span> <span id="mqtt_status" class="value">--</span></p>
        <p><span class="label">Last Update:</span> <span id="last_update" class="value">--</span></p>
        
        <h2>Device Status</h2>
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
            <span class="label" style="font-weight: bold;">Watering Mode:</span>
            <select id="wateringModeSelect" style="font-size: 1em; padding: 8px; border-radius: 6px; border: 1px solid #ccc;">
                <option value="AUTO">AUTO</option>
                <option value="MANUAL">MANUAL</option>
                <option value="MAINTENANCE">MAINTENANCE</option>
            </select>
        </div>
        <p><span class="label">Device Time:</span> <span id="device_time" class="value">--</span></p>
        <p><span class="label">Uptime:</span> <span id="uptime" class="value">--</span></p>
        <p><span class="label">Last Watering Time:</span> <span id="last_watering_time" class="value">--</span></p>
        <p><span class="label">Software Version:</span> <span id="soft_ver" class="value">--</span></p>
        <p><span class="label">App Status:</span> <span id="app_status" class="value">--</span></p>
        <p><span class="label">Error Code:</span> <span id="error_code" class="value">--</span></p>

        <h2>Sensors</h2>
        <p><span class="label">IN0:</span> <span id="li0_state" class="value">--</span></p>
        <p><span class="label">IN1:</span> <span id="li1_state" class="value">--</span></p>
        <p><span class="label">Temperature:</span> <span id="temp_adc1_c_val" class="value">-- &deg;C</span></p>
        <p><span class="label">Soil Moisture:</span> <span id="adc0_val" class="value">-- mV</span></p>
        
        <h2>Pump Control (OUT0)</h2>
        <div class="pump-control-group">
            <p><span class="label">OUT0:</span> <span id="out0_state" class="value">--</span></p>
            <div class="btn-group-single" id="manual_water_btn_group">
                <button type="button" id="manual_water_btn" class="btn btn-action">Run Manual Cycle</button>
            </div>
            <div class="btn-group" id="maintenance_pump_btn_group">
                <button type="button" id="maintenance_pump_on_btn" class="btn btn-on">Force ON</button>
                <button type="button" id="maintenance_pump_off_btn" class="btn btn-off">Force OFF</button>
            </div>
        </div>
    </div>

    <div id="deviceModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Add Device</h2>
            <form id="deviceForm">
                <input type="hidden" id="editDeviceId">
                
                <label for="deviceName">Nickname</label>
                <input type="text" id="deviceName" required>

                <label for="deviceId">Device ID</label>
                <input type="text" id="deviceId" required>

                <label for="devicePassword">MQTT Password</label>
                <input type="password" id="devicePassword">
                <small>Leave blank to keep current password when editing.</small>

                <label for="deviceBroker">MQTT Broker Host</label>
                <input type="text" id="deviceBroker" required>

                <label for="deviceWsPort">MQTT WebSocket Port</label>
                <input type="number" id="deviceWsPort" required>

                <label for="deviceUsername">MQTT Username</label>
                <input type="text" id="deviceUsername">

                <div class="modal-buttons">
                    <button type="button" id="cancelDeviceBtn">Cancel</button>
                    <button type="submit" id="saveDeviceBtn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let currentDeviceConfig = null;

            let mqttClient = null;
            let stalenessTimer = null;
            let serviceWorkerRegistration = null;
            let isSubscribed = false;
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ›´æ–°é–“éš”60ç§’ã®1.5å€å¼·ã«è¨­å®š
            const STALE_DATA_TIMEOUT_MS = 95000; 

            function updateUI(id, value, className = null) {
                const element = document.getElementById(id);
                if (element) {
                    const newClassName = className ? 'value ' + className : 'value';
                    // æ¯”è¼ƒã¨è¡¨ç¤ºã®ãŸã‚ã«ã€å—ã‘å–ã£ãŸå€¤ã‚’æ–‡å­—åˆ—ã«å¤‰æ›ã™ã‚‹
                    // ã“ã‚Œã«ã‚ˆã‚Šã€ '0' (æ–‡å­—åˆ—) ã¨ 0 (æ•°å€¤) ãŒç•°ãªã‚‹ã¨åˆ¤æ–­ã•ã‚Œã‚‹å•é¡Œã‚’å›é¿ã™ã‚‹
                    const stringValue = (value === null || typeof value === 'undefined') ? element.innerHTML : String(value);
                    // å€¤ã¾ãŸã¯ã‚¯ãƒ©ã‚¹åãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã«ã®ã¿UIã‚’æ›´æ–°ã—ã€ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹
                    if (element.innerHTML !== stringValue || element.className !== newClassName) {
                        element.innerHTML = stringValue;
                        element.className = newClassName;
                        // ãƒ­ãƒ¼ã‚«ãƒ«Web UIã¨åŒæ§˜ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆåŠ¹æœã‚’é©ç”¨
                        element.style.backgroundColor = '#cce5ff';
                        setTimeout(() => { element.style.backgroundColor = ''; }, 2000);
                    }
                }
            }

            function resetDisplay() {
                const fieldsToReset = {
                    'uptime': '--',
                    'last_watering_time': '--',
                    'soft_ver': '--',
                    'device_time': '--',
                    'app_status': '--',
                    'error_code': '--',
                    'li0_state': { value: '--', className: '' },
                    'li1_state': { value: '--', className: '' },
                    'temp_adc1_c_val': { value: '-- &deg;C' },
                    'adc0_val': { value: '-- mV' },
                    'watering_mode': 'MAINTENANCE',
                    'out0_state': { value: '--', className: '' },
                    'out1_state': { value: '--', className: '' },
                    'last_update': '--',
                    'mqtt_status': '--'
                };

                for (const id in fieldsToReset) {
                    const field = fieldsToReset[id];
                    updateUI(id, (field.value !== undefined ? field.value : field), field.className || '');
                }
                if (stalenessTimer) {
                    clearTimeout(stalenessTimer);
                }
            }

            function onMessageArrived(message) {
                try {
                    // --- 1. æœ€çµ‚æ›´æ–°æ™‚åˆ»ã¨é®®åº¦ã‚’æ›´æ–° ---
                    const now = new Date();
                    const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
                    updateUI('last_update', `Received at ${timeString}`);
                    document.getElementById('last_update').className = 'value'; // è­¦å‘Šè‰²ã‚’ãƒªã‚»ãƒƒãƒˆ

                    // å¤ã„è­¦å‘Šã‚¿ã‚¤ãƒãƒ¼ã‚’è§£é™¤ã—ã€æ–°ã—ã„ã‚¿ã‚¤ãƒãƒ¼ã‚’è¨­å®š
                    if (stalenessTimer) {
                        clearTimeout(stalenessTimer);
                    }
                    stalenessTimer = setTimeout(() => {
                        // ã“ã®ã‚¿ã‚¤ãƒãƒ¼ãŒä½œå‹•ã™ã‚‹ã¨ã„ã†ã“ã¨ã¯ã€ä¸€å®šæ™‚é–“ãƒ‡ãƒ¼ã‚¿ãŒæ¥ã¦ã„ãªã„ã¨ã„ã†ã“ã¨
                        updateUI('last_update', 'Data is stale. Check device.', 'status-off');
                    }, STALE_DATA_TIMEOUT_MS);

                    // --- 2. å—ä¿¡ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ç”»é¢ã«è¡¨ç¤º ---
                    const data = JSON.parse(message.payloadString);
                    const fields = {
                        'uptime': data.uptime,
                        'last_watering_time': data.last_watering_time,
                        'soft_ver': data.soft_ver,
                        'device_time': data.device_time,
                        'app_status': data.app_status,
                        'error_code': data.error_code,
                        'li0_state': { value: data.li0_state, className: data.li0_class },
                        'li1_state': { value: data.li1_state, className: data.li1_class },
                        'temp_adc1_c_val': { value: `${data.temp_adc1_c_val} &deg;C` },
                        'adc0_val': { value: `${data.adc0_val} mV` },
                        'watering_mode': data.watering_mode,
                        'out0_state': { value: data.out0_state, className: data.out0_class },
                        'out1_state': { value: data.out1_state, className: data.out1_class }
                    };
                    for (const id in fields) {
                        const field = fields[id];
                        if (typeof field === 'object' && field !== null) {
                            updateUI(id, field.value, field.className);
                        } else {
                            updateUI(id, field);
                        }
                    }

                    // Update UI based on watering mode
                    const mode = data.watering_mode || 'MAINTENANCE';
                    document.getElementById('wateringModeSelect').value = mode;

                    const manualGroup = document.getElementById('manual_water_btn_group');
                    const maintenanceGroup = document.getElementById('maintenance_pump_btn_group');
                    const manualBtn = document.getElementById('manual_water_btn');
                    const maintOnBtn = document.getElementById('maintenance_pump_on_btn');
                    const maintOffBtn = document.getElementById('maintenance_pump_off_btn');

                    if (mode === 'MANUAL') {
                        manualGroup.style.display = 'flex';
                        maintenanceGroup.style.display = 'none';
                        manualBtn.disabled = false;
                    } else if (mode === 'MAINTENANCE') {
                        manualGroup.style.display = 'none';
                        maintenanceGroup.style.display = 'flex';
                        maintOnBtn.disabled = false;
                        maintOffBtn.disabled = false;
                    } else { // AUTO or other
                        manualGroup.style.display = 'flex'; // Show the button but disabled
                        maintenanceGroup.style.display = 'none';
                        manualBtn.disabled = true;
                    }
                } catch (e) {
                    console.error("Error parsing MQTT message:", e);
                }
            }

            function publishMqttCommand(command) {
                if (currentDeviceConfig && mqttClient && mqttClient.isConnected()) {
                    const message = new Paho.Message(JSON.stringify(command));
                    message.destinationName = `devices/${currentDeviceConfig.deviceId}/control`;
                    mqttClient.send(message);
                } else {
                    alert("MQTT not connected. Cannot send command.");
                }
            }

            // --- Event Listeners ---
            document.getElementById('manual_water_btn').addEventListener('click', () => publishMqttCommand({lo: {bit: 0, value: 1}}));
            document.getElementById('maintenance_pump_on_btn').addEventListener('click', () => publishMqttCommand({lo: {bit: 0, value: 1}}));
            document.getElementById('maintenance_pump_off_btn').addEventListener('click', () => publishMqttCommand({lo: {bit: 0, value: 0}}));
            
            document.getElementById('addDeviceBtn').addEventListener('click', () => showDeviceModal());
            document.getElementById('editDeviceBtn').addEventListener('click', () => {
                const selectedId = document.getElementById('deviceSelect').value;
                if (!selectedId) {
                    alert("No device selected to edit.");
                    return;
                }
                const devices = loadDevices();
                const selectedDevice = devices.find(d => d.deviceId === selectedId);
                if (selectedDevice) {
                    showDeviceModal(selectedDevice);
                }
            });
            document.getElementById('deleteDeviceBtn').addEventListener('click', handleDeleteDevice);
            document.getElementById('deviceSelect').addEventListener('change', handleDeviceChange);
            document.getElementById('cancelDeviceBtn').addEventListener('click', hideDeviceModal);
            document.getElementById('deviceForm').addEventListener('submit', handleSaveDevice);
            document.getElementById('wateringModeSelect').addEventListener('change', (event) => {
                if (confirm(`Change watering mode to ${event.target.value} and reboot the device?`)) {
                    publishMqttCommand({ set_watering_mode: event.target.value });
                }
            });

            function connectToDevice(deviceConfig) {
                if (!deviceConfig) return;

                currentDeviceConfig = deviceConfig;
                localStorage.setItem('deviceRemoteLastSelected', deviceConfig.deviceId);

                if (mqttClient && mqttClient.isConnected()) {
                    mqttClient.disconnect();
                }

                const clientId = "remote-control-" + Math.random().toString(36).substring(2, 15);
                mqttClient = new Paho.Client(deviceConfig.broker, Number(deviceConfig.ws_port), clientId);

                mqttClient.onConnectionLost = (response) => {
                    if (response.errorCode !== 0) {
                        updateUI('mqtt_status', `Connection Lost: ${response.errorMessage}`, 'status-off');
                        // ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã¨ã®æ¥ç¶šãŒåˆ‡ã‚ŒãŸã‚‰ã€è­¦å‘Šã‚¿ã‚¤ãƒãƒ¼ã‚‚åœæ­¢
                        if (stalenessTimer) {
                            clearTimeout(stalenessTimer);
                        }
                        updateUI('last_update', 'Broker connection lost.', 'status-off');
                    }
                };
                mqttClient.onMessageArrived = onMessageArrived;

                const connectOptions = {
                    onSuccess: () => {
                        updateUI('mqtt_status', 'Connected', 'status-on');
                        mqttClient.subscribe(`devices/${deviceConfig.deviceId}/status`);
                    },
                    onFailure: (response) => {
                        updateUI('mqtt_status', `Failed: ${response.errorMessage}`, 'status-off');
                    },
                    userName: deviceConfig.username,
                    password: deviceConfig.password,
                    useSSL: true,
                    reconnect: true
                };
                updateUI('mqtt_status', 'Connecting...');
                mqttClient.connect(connectOptions);
            }

            // --- Device Management ---
            function loadDevices() {
                const saved = localStorage.getItem('deviceRemoteDevices');
                return saved ? JSON.parse(saved) : [];
            }

            function saveDevices(devices) {
                localStorage.setItem('deviceRemoteDevices', JSON.stringify(devices));
            }

            function populateDeviceSelector(devices, selectedDeviceId) {
                const select = document.getElementById('deviceSelect');
                select.innerHTML = '';
                devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.textContent = device.name;
                    if (device.deviceId === selectedDeviceId) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            }

            function showDeviceModal(device = null) {
                const form = document.getElementById('deviceForm');
                form.reset();

                const modalTitle = document.getElementById('modalTitle');
                const editDeviceIdInput = document.getElementById('editDeviceId');
                const deviceIdInput = document.getElementById('deviceId');

                if (device) { // Editing
                    modalTitle.textContent = 'Edit Device';
                    editDeviceIdInput.value = device.deviceId;
                    
                    document.getElementById('deviceName').value = device.name;
                    deviceIdInput.value = device.deviceId;
                    deviceIdInput.readOnly = true;
                    document.getElementById('devicePassword').placeholder = 'Leave blank to keep current';
                    document.getElementById('devicePassword').value = '';
                    document.getElementById('deviceBroker').value = device.broker;
                    document.getElementById('deviceWsPort').value = device.ws_port;
                    document.getElementById('deviceUsername').value = device.username;
                } else { // Adding
                    modalTitle.textContent = 'Add New Device';
                    editDeviceIdInput.value = '';
                    deviceIdInput.readOnly = false;
                    document.getElementById('devicePassword').placeholder = '';
                }

                document.getElementById('deviceModal').style.display = 'flex';
            }

            function hideDeviceModal() {
                document.getElementById('deviceModal').style.display = 'none';
            }

            function handleSaveDevice(event) {
                event.preventDefault();

                const editId = document.getElementById('editDeviceId').value;
                const isEditing = !!editId;

                const config = {
                    name: document.getElementById('deviceName').value.trim(),
                    deviceId: document.getElementById('deviceId').value.trim(),
                    password: document.getElementById('devicePassword').value,
                    broker: document.getElementById('deviceBroker').value.trim(),
                    ws_port: Number(document.getElementById('deviceWsPort').value),
                    username: document.getElementById('deviceUsername').value.trim()
                };

                if (!config.name || !config.deviceId || !config.broker || !config.ws_port) {
                    alert('Please fill in all required fields.');
                    return;
                }

                let devices = loadDevices();

                if (isEditing) {
                    const deviceIndex = devices.findIndex(d => d.deviceId === editId);
                    if (deviceIndex > -1) {
                        if (!config.password) config.password = devices[deviceIndex].password;
                        devices[deviceIndex] = config;
                    }
                } else {
                    if (devices.some(d => d.deviceId === config.deviceId)) {
                        alert('A device with this ID already exists.');
                        return;
                    }
                    devices.push(config);
                }
                saveDevices(devices);
                populateDeviceSelector(devices, config.deviceId);
                connectToDevice(config);
                hideDeviceModal();
            }

            function handleDeleteDevice() {
                const selectedId = document.getElementById('deviceSelect').value;
                if (!selectedId) {
                    alert("No device selected to delete.");
                    return;
                }
                if (!confirm(`Are you sure you want to delete the device "${document.getElementById('deviceSelect').options[document.getElementById('deviceSelect').selectedIndex].text}"?`)) {
                    return;
                }

                let devices = loadDevices();
                devices = devices.filter(d => d.deviceId !== selectedId);
                saveDevices(devices);
                
                // Reload the page to connect to the first available device or prompt for a new one
                location.reload();
            }

            function handleDeviceChange() {
                resetDisplay(); // ãƒ‡ãƒã‚¤ã‚¹åˆ‡ã‚Šæ›¿ãˆæ™‚ã«è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
                const selectedId = document.getElementById('deviceSelect').value;
                const devices = loadDevices();
                const selectedDevice = devices.find(d => d.deviceId === selectedId);
                connectToDevice(selectedDevice);

                // ãƒ‡ãƒã‚¤ã‚¹ãŒåˆ‡ã‚Šæ›¿ã‚ã£ãŸã‚‰ã€ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã®è³¼èª­çŠ¶æ…‹ã‚’å†è©•ä¾¡ã—ã€ãƒœã‚¿ãƒ³UIã‚’æ›´æ–°
                if (serviceWorkerRegistration) {
                    initializePushUI();
                }
            }

            // --- Initial Execution ---
            let devices = loadDevices();
            if (devices.length === 0) {
                alert("No devices configured. Let's add your first one.");
                showDeviceModal();
            } else {
                const lastSelectedId = localStorage.getItem('deviceRemoteLastSelected');
                populateDeviceSelector(devices, lastSelectedId);
                handleDeviceChange(); // Connect to the selected device
            }

            // --- Push Notification Functions ---

            function initializePushNotifications() {
                if ('serviceWorker' in navigator && 'PushManager' in window) {
                    console.log('Service Worker and Push is supported');
                    navigator.serviceWorker.register('./sw.js')
                        .then(function(swReg) {
                            console.log('Service Worker is registered', swReg);
                            serviceWorkerRegistration = swReg;
                            initializePushUI();
                        })
                        .catch(function(error) {
                            console.error('Service Worker registration failed:', error);
                            const pushStatusMessage = document.getElementById('push-status-message');
                            document.getElementById('pushSubscribeBtn').style.display = 'none'; // ãƒœã‚¿ãƒ³ã¯éš ã™
                            pushStatusMessage.textContent = 'ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“';
                            pushStatusMessage.title = 'Push notifications require a secure connection (HTTPS) and are not available on local files.';
                            pushStatusMessage.style.display = 'inline'; // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                        });
                } else {
                    console.warn('Push messaging is not supported');
                    const pushStatusMessage = document.getElementById('push-status-message');
                    document.getElementById('pushSubscribeBtn').style.display = 'none'; // ãƒœã‚¿ãƒ³ã¯éš ã™
                    pushStatusMessage.textContent = 'ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶';
                    pushStatusMessage.title = 'Your browser does not support push notifications.';
                    pushStatusMessage.style.display = 'inline'; // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                }
            }

            function initializePushUI() {
                const pushButton = document.getElementById('pushSubscribeBtn');                
                pushButton.style.display = 'block'; // ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºçŠ¶æ…‹ã«ã™ã‚‹

                // ãƒœã‚¿ãƒ³ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒãªã‘ã‚Œã°è¨­å®šã™ã‚‹
                if (!pushButton.hasAttribute('data-listener-attached')) {
                    pushButton.addEventListener('click', function() {
                        pushButton.disabled = true; // å‡¦ç†ä¸­ã«é€£æ‰“ã•ã‚Œã‚‹ã®ã‚’é˜²ã
                        if (isSubscribed) {
                            unsubscribeUserFromPush();
                        } else {
                            subscribeUserToPush();
                        }
                    });
                    pushButton.setAttribute('data-listener-attached', 'true');
                }

                serviceWorkerRegistration.pushManager.getSubscription()
                    .then(function(subscription) {
                        isSubscribed = !(subscription === null);
                        pushButton.disabled = false; // çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ãŒçµ‚ã‚ã£ãŸã‚‰æ“ä½œå¯èƒ½ã«
                        updatePushButtonUI();
                    });
            }

            function updatePushButtonUI() {
                const pushButton = document.getElementById('pushSubscribeBtn');
                if (!pushButton) return;

                const selectedDeviceId = document.getElementById('deviceSelect').value;

                if (isSubscribed) {
                    pushButton.textContent = 'é€šçŸ¥ã‚’ç„¡åŠ¹ã«ã™ã‚‹';
                    pushButton.title = 'Disable error notifications for the selected device';
                    pushButton.classList.remove('btn-push-off');
                    pushButton.classList.add('btn-push-on');
                } else {
                    pushButton.textContent = 'é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹';
                    pushButton.title = 'Enable error notifications for the selected device';
                    pushButton.classList.remove('btn-push-on');
                    pushButton.classList.add('btn-push-off');
                }
            }

            function unsubscribeUserFromPush() {
                serviceWorkerRegistration.pushManager.getSubscription()
                    .then(function(subscription) {
                        if (subscription) {
                            const selectedDeviceId = document.getElementById('deviceSelect').value;
                            if (!selectedDeviceId) {
                                alert('é€šçŸ¥ã‚’ç„¡åŠ¹ã«ã™ã‚‹ãƒ‡ãƒã‚¤ã‚¹ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                                document.getElementById('pushSubscribeBtn').disabled = false; // ãƒœã‚¿ãƒ³ã‚’å†åº¦æœ‰åŠ¹åŒ–
                                throw new Error('No device selected for unsubscription.');
                            }

                            // â˜…â˜…â˜… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«è³¼èª­è§£é™¤ã‚’é€šçŸ¥ã™ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ â˜…â˜…â˜…
                            // ã“ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯Lambdaå´ã§åˆ¥é€”å®Ÿè£…ãŒå¿…è¦ã§ã™ã€‚
                            const awsApiGatewayUnregisterUrl = 'https://fasg4dmog5.execute-api.ap-southeast-2.amazonaws.com/unregister-subscription';

                            // ã‚µãƒ¼ãƒãƒ¼ã«è³¼èª­è§£é™¤ã‚’é€šçŸ¥
                            fetch(awsApiGatewayUnregisterUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    deviceId: selectedDeviceId,
                                    endpoint: subscription.endpoint // ã©ã®è³¼èª­ã‚’è§£é™¤ã™ã‚‹ã‹ã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã«endpointã‚’é€ä¿¡
                                })
                            })
                            .then(response => {
                                if (!response.ok) {
                                    // ã‚µãƒ¼ãƒãƒ¼å´ã§å¤±æ•—ã—ã¦ã‚‚ã€ãƒ–ãƒ©ã‚¦ã‚¶å´ã®è³¼èª­è§£é™¤ã¯è©¦ã¿ã‚‹
                                    console.error(`Server responded with ${response.status} on unregister.`);
                                }
                                console.log('Successfully unregistered on server.');
                                // ã‚µãƒ¼ãƒãƒ¼å´ã®å‡¦ç†æˆå¦ã«é–¢ã‚ã‚‰ãšã€ãƒ–ãƒ©ã‚¦ã‚¶ã®è³¼èª­ã‚’è§£é™¤
                                return subscription.unsubscribe();
                            })
                            .then(function(successful) {
                                if (successful) {
                                    console.log('Successfully unsubscribed from push notifications (browser-side).');
                                    isSubscribed = false;
                                } else {
                                    console.error('Failed to unsubscribe (browser-side).');
                                    isSubscribed = true; // å¤±æ•—ã—ãŸã®ã§çŠ¶æ…‹ã¯è³¼èª­ä¸­ã®ã¾ã¾
                                }
                            })
                            .catch(function(e) {
                                console.error('Error during unsubscription process: ', e);
                                isSubscribed = true; // å¤±æ•—ã—ãŸã®ã§çŠ¶æ…‹ã¯è³¼èª­ä¸­ã®ã¾ã¾
                            })
                            .finally(function() {
                                document.getElementById('pushSubscribeBtn').disabled = false; // å‡¦ç†å®Œäº†å¾Œã«ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                                updatePushButtonUI(); // æœ€çµ‚çš„ãªçŠ¶æ…‹ã§UIã‚’æ›´æ–°
                            });
                        } else {
                            // è³¼èª­æƒ…å ±ãŒãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
                            document.getElementById('pushSubscribeBtn').disabled = false; // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                            isSubscribed = false;
                            updatePushButtonUI();
                        }
                    });
            }

            function subscribeUserToPush() {
                const applicationServerKey = "BL1XYSPIcZtwwXetpPrTuOxxwy4EMaiE1eDkdi5y59h3R99nZ3hJmR27lcCKWyI8_2r7KRKdQd_SoFUVkeaQ2sg";
                const applicationServerKeyDecoded = urlBase64ToUint8Array(applicationServerKey);

                serviceWorkerRegistration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: applicationServerKeyDecoded
                })
                .then(function(subscription) {
                    console.log('User is subscribed:', subscription);
                    const awsApiGatewayUrl = 'https://fasg4dmog5.execute-api.ap-southeast-2.amazonaws.com/register-subscription';

                    const selectedDeviceId = document.getElementById('deviceSelect').value;
                    if (!selectedDeviceId) {
                        alert('é€šçŸ¥ã‚’ç™»éŒ²ã™ã‚‹ãƒ‡ãƒã‚¤ã‚¹ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                        document.getElementById('pushSubscribeBtn').disabled = false; // ãƒœã‚¿ãƒ³ã‚’å†åº¦æœ‰åŠ¹åŒ–
                        // ãƒ‡ãƒã‚¤ã‚¹IDãŒãªã„å ´åˆã¯ãƒ–ãƒ©ã‚¦ã‚¶å´ã‚‚è³¼èª­è§£é™¤
                        subscription.unsubscribe();
                        throw new Error('No device selected for notification registration.');
                    }

                    return fetch(awsApiGatewayUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        // deviceIdã¨subscriptionã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¸¡æ–¹é€ä¿¡ã™ã‚‹
                        body: JSON.stringify({ deviceId: selectedDeviceId, subscription: subscription })
                    });
                })
                .then(response => {
                    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ãŒæˆåŠŸ(2xx)ã§ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã‚‹
                    if (!response.ok) {
                        throw new Error(`Server responded with ${response.status}: ${response.statusText}`);
                    }
                    console.log('Subscription saved successfully on server.');
                    isSubscribed = true; // ã‚µãƒ¼ãƒãƒ¼ç™»éŒ²æˆåŠŸæ™‚ã«çŠ¶æ…‹ã‚’æ›´æ–°
                })
                .catch(function(err) {
                    console.error('Failed to subscribe or save the subscription: ', err);
                    alert('ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã®æœ‰åŠ¹åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    isSubscribed = false; // å¤±æ•—ã—ãŸã®ã§çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                })
                .finally(function() {
                    // æˆåŠŸãƒ»å¤±æ•—ã«é–¢ã‚ã‚‰ãšUIã‚’æœ€çµ‚çŠ¶æ…‹ã«æ›´æ–°
                    document.getElementById('pushSubscribeBtn').disabled = false; // å‡¦ç†å®Œäº†å¾Œã«ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                    updatePushButtonUI();
                });
            }

            function urlBase64ToUint8Array(base64String) {
                const padding = '='.repeat((4 - base64String.length % 4) % 4);
                const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
                const rawData = window.atob(base64);
                const outputArray = new Uint8Array(rawData.length);
                for (let i = 0; i < rawData.length; ++i) {
                    outputArray[i] = rawData.charCodeAt(i);
                }
                return outputArray;
            }

            initializePushNotifications(); // ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥æ©Ÿèƒ½ã‚’åˆæœŸåŒ–
        });
    </script>
</body>
</html>
